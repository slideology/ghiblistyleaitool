# 环境变量获取配置指南

本指南将详细说明如何获取项目所需的各种API密钥和环境变量。

## 🔧 必需配置项（影响核心功能）

### 1. Cloudflare 配置

#### 获取 ACCOUNT_TOKEN
**步骤：**
1. 登录 [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. 点击右上角头像 → "My Profile"
3. 选择 "API Tokens" 标签
4. 点击 "Create Token"
5. 选择 "Custom token" 模板
6. 配置权限：
   - Account: Cloudflare Workers:Edit
   - Zone: Zone:Read
   - Zone Resources: Include All zones
7. 点击 "Continue to summary" → "Create Token"
8. 复制生成的 token 到 `.env` 文件的 `ACCOUNT_TOKEN`

**影响：** 缺失将导致数据库迁移失败，无法部署

#### 获取 ACCOUNT_ID 和 DATABASE_ID
**步骤：**
1. 在 Cloudflare Dashboard 中
2. 右侧边栏可以看到 "Account ID"，复制到 `ACCOUNT_ID`
3. 进入 "Workers & Pages" → "D1 SQL Database"
4. 选择你的数据库，在详情页面可以看到 "Database ID"

### 2. Google OAuth 配置

#### 获取 GOOGLE_CLIENT_ID 和 GOOGLE_CLIENT_SECRET
**步骤：**
1. 访问 [Google Cloud Console](https://console.cloud.google.com/)
2. 创建新项目或选择现有项目
3. 启用 "Google+ API" 和 "People API"
4. 进入 "APIs & Services" → "Credentials"
5. 点击 "Create Credentials" → "OAuth 2.0 Client IDs"
6. 选择 "Web application"
7. 配置重定向 URI：
   - 开发环境：`http://localhost:8787/callback/google`
   - 生产环境：`https://yourdomain.com/callback/google`
8. 创建后复制 Client ID 和 Client Secret

**影响：** 缺失将导致用户无法通过Google登录

### 3. KIE AI API 配置

#### 获取 KIEAI_APIKEY
**步骤：**
1. 访问 [KIE AI 官网](https://kie.ai/)
2. 注册账户并登录
3. 进入开发者控制台
4. 创建新的API密钥
5. 复制API密钥到 `KIEAI_APIKEY`

**影响：** 缺失将导致AI图片生成功能无法使用

## 🌐 域名和CDN配置

### 4. 域名配置

#### 配置 DOMAIN
**步骤：**
1. 购买域名（推荐使用Cloudflare注册）
2. 在Cloudflare中添加域名
3. 更新 `.env` 中的 `DOMAIN=https://yourdomain.com`
4. 在 `wrangler.jsonc` 中更新相同域名

#### 配置 CDN_URL
**步骤：**
1. 如果使用Cloudflare R2，CDN_URL通常是：`https://your-bucket.your-account.r2.cloudflarestorage.com`
2. 或者配置自定义域名指向R2存储桶
3. 更新 `.env` 中的 `CDN_URL`

**影响：** 缺失将导致图片无法正确显示，回调URL错误

## 💳 支付系统配置（可选）

### 5. Creem 支付配置

#### 获取 CREEM_KEY, CREEM_TEST_KEY, CREEM_WEBHOOK_SECRET
**步骤：**
1. 访问 [Creem 官网](https://creem.io/)
2. 注册商户账户
3. 完成商户认证
4. 在开发者控制台获取：
   - 生产环境密钥 → `CREEM_KEY`
   - 测试环境密钥 → `CREEM_TEST_KEY`
   - Webhook密钥 → `CREEM_WEBHOOK_SECRET`

**影响：** 缺失将导致付费功能无法使用，但不影响基础功能

## 📊 分析和广告配置（可选）

### 6. Google Analytics 配置

#### 获取 GOOGLE_ANALYTICS_ID
**步骤：**
1. 访问 [Google Analytics](https://analytics.google.com/)
2. 创建新的GA4属性
3. 获取测量ID（格式：G-XXXXXXXXX）
4. 更新 `.env` 中的 `GOOGLE_ANALYTICS_ID`

### 7. Google Ads 配置

#### 获取 GOOGLE_ADS_ID
**步骤：**
1. 访问 [Google AdSense](https://www.google.com/adsense/)
2. 创建AdSense账户
3. 获取发布商ID（格式：pub-xxxxxxxxxxxxxxxx）
4. 更新 `.env` 中的 `GOOGLE_ADS_ID`

**影响：** 缺失不影响功能，但无法进行数据分析和广告展示

## 🔐 安全配置

### 8. SESSION_SECRET
**步骤：**
1. 生成一个强随机字符串（建议32位以上）
2. 可以使用在线工具或命令：`openssl rand -base64 32`
3. 更新 `.env` 中的 `SESSION_SECRET`

**影响：** 已配置，用于会话加密

## 📋 配置优先级

### 🚨 立即需要配置（影响部署）
1. **ACCOUNT_TOKEN** - 数据库迁移必需
2. **DOMAIN** - 回调URL配置必需
3. **CDN_URL** - 图片显示必需

### ⚠️ 功能需要配置
1. **GOOGLE_CLIENT_ID/SECRET** - 用户登录必需
2. **KIEAI_APIKEY** - AI功能必需

### 💡 可选配置
1. **CREEM相关** - 付费功能
2. **GOOGLE_ANALYTICS_ID** - 数据分析
3. **GOOGLE_ADS_ID** - 广告展示

## 🛠️ 配置验证

配置完成后，可以通过以下方式验证：

```bash
# 检查环境变量
cat .env

# 测试数据库连接
pnpm run db:migrate

# 本地测试
pnpm run dev
```

## 📝 注意事项

1. **安全性**：
   - 不要将 `.env` 文件提交到版本控制
   - 定期更换API密钥
   - 使用强密码和密钥

2. **环境区分**：
   - 开发环境和生产环境使用不同的密钥
   - 测试时使用测试环境的API

3. **备份**：
   - 保存好所有密钥的备份
   - 记录密钥的获取时间和用途

## 🆘 常见问题

**Q: ACCOUNT_TOKEN权限不足怎么办？**
A: 确保token包含 Cloudflare Workers:Edit 和 Zone:Read 权限

**Q: Google OAuth重定向失败？**
A: 检查重定向URI是否与实际部署域名一致

**Q: KIE AI API调用失败？**
A: 确认API密钥有效且账户有足够余额

**Q: 图片无法显示？**
A: 检查CDN_URL配置和R2存储桶权限设置

---

按照此指南逐步配置，可以确保项目正常运行。如有问题，请参考各服务的官方文档或联系技术支持。