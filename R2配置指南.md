# Cloudflare R2 存储桶配置指南

## 问题描述

当前项目中的图片无法正常显示，错误信息为 "Image fetch failed"。经过分析发现，问题的根源是 R2 存储桶的直接 URL (`https://ai-hairstyle.slideology0816.r2.cloudflarestorage.com`) 无法公开访问。

## 解决方案

有两种方法可以解决这个问题：

### 方案一：配置 R2 存储桶公共访问（推荐）

#### 步骤 1：登录 Cloudflare Dashboard
1. 访问 [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. 登录您的账户
3. 选择您的账户

#### 步骤 2：进入 R2 存储桶设置
1. 在左侧菜单中点击 "R2 Object Storage"
2. 找到并点击 `ai-hairstyle` 存储桶
3. 进入存储桶详情页面

#### 步骤 3：启用公共访问
1. 点击 "Settings" 标签
2. 找到 "Public access" 部分
3. 点击 "Allow Access" 按钮
4. 在弹出的对话框中确认启用公共访问
5. 复制生成的公共 URL（格式类似：`https://pub-xxxxxxxxx.r2.dev`）

#### 步骤 4：更新环境变量
1. 打开项目根目录下的 `.env` 文件
2. 将 `CDN_URL` 更新为新的公共 URL：
   ```bash
   CDN_URL=https://pub-xxxxxxxxx.r2.dev
   ```
3. 同时更新 `wrangler.jsonc` 文件中的 `CDN_URL`：
   ```json
   "CDN_URL": "https://pub-xxxxxxxxx.r2.dev"
   ```

### 方案二：配置自定义域名（高级用户）

#### 前提条件
- 您需要拥有一个域名
- 该域名需要使用 Cloudflare 作为 DNS 服务商

#### 步骤 1：添加自定义域名
1. 在 R2 存储桶详情页面，点击 "Settings" 标签
2. 找到 "Custom domains" 部分
3. 点击 "Connect Domain" 按钮
4. 输入您想要使用的子域名（例如：`cdn.yourdomain.com`）
5. 点击 "Continue"

#### 步骤 2：配置 DNS 记录
1. Cloudflare 会自动为您创建必要的 DNS 记录
2. 等待 DNS 传播完成（通常需要几分钟到几小时）

#### 步骤 3：更新环境变量
1. 将 `CDN_URL` 更新为您的自定义域名：
   ```bash
   CDN_URL=https://cdn.yourdomain.com
   ```
2. 同时更新 `wrangler.jsonc` 文件

#### 步骤 4：启用自定义域名路由（可选）
如果您想要为整个应用使用自定义域名，可以在 `wrangler.jsonc` 中取消注释并配置：
```json
"routes": [
  {
    "pattern": "yourdomain.com",
    "custom_domain": true
  },
  {
    "pattern": "www.yourdomain.com",
    "custom_domain": true
  }
]
```

## 验证配置

### 测试 R2 访问
配置完成后，您可以通过以下方式验证：

1. **浏览器测试**：
   - 在浏览器中直接访问新的 CDN URL
   - 应该能够看到存储桶的内容或者得到正确的响应

2. **命令行测试**：
   ```bash
   curl -I https://your-new-cdn-url.com
   ```
   应该返回 200 状态码

3. **应用测试**：
   - 重新部署应用
   - 测试图片上传和显示功能

## 重新部署应用

配置完成后，需要重新部署应用以使更改生效：

```bash
# 构建应用
npm run build

# 部署到 Cloudflare Workers
npm run deploy
```

## 常见问题

### Q: 启用公共访问后，所有文件都可以被任何人访问吗？
A: 是的，启用公共访问后，存储桶中的所有文件都可以通过公共 URL 访问。如果您需要更精细的访问控制，建议使用自定义域名配合 Cloudflare 的安全规则。

### Q: 自定义域名配置失败怎么办？
A: 请确保：
- 域名已经添加到 Cloudflare 并且 DNS 状态为 "Active"
- 等待足够的时间让 DNS 记录传播
- 检查域名是否已经被其他服务使用

### Q: 更改 CDN_URL 后，之前上传的图片还能访问吗？
A: 可以，因为图片的存储路径（key）没有改变，只是访问的基础 URL 发生了变化。

### Q: 如何回滚配置？
A: 如果新配置出现问题，您可以：
1. 在 Cloudflare Dashboard 中禁用公共访问或删除自定义域名
2. 将 `CDN_URL` 恢复为原来的值
3. 重新部署应用

## 安全建议

1. **定期审查存储桶内容**：确保没有敏感文件被意外上传
2. **使用 Cloudflare 安全功能**：如果使用自定义域名，可以配置防火墙规则、速率限制等
3. **监控访问日志**：定期检查访问日志，发现异常访问模式
4. **备份重要数据**：定期备份存储桶中的重要文件

## 总结

推荐使用 **方案一（公共访问）** 来快速解决当前的图片显示问题。这是最简单、最直接的解决方案，适合大多数使用场景。如果您对安全性有更高要求或者希望使用自己的域名，可以选择方案二。

配置完成后，您的 AI 发型变换应用就能正常显示生成的图片了！